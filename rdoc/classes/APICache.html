<?xml version="1.0" encoding="iso-8859-1"?>
<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <title>Class: APICache</title>
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
  <meta http-equiv="Content-Script-Type" content="text/javascript" />
  <link rel="stylesheet" href=".././rdoc-style.css" type="text/css" media="screen" />
  <script type="text/javascript">
  // <![CDATA[

  function popupCode( url ) {
    window.open(url, "Code", "resizable=yes,scrollbars=yes,toolbar=no,status=no,height=150,width=400")
  }

  function toggleCode( id ) {
    if ( document.getElementById )
      elem = document.getElementById( id );
    else if ( document.all )
      elem = eval( "document.all." + id );
    else
      return false;

    elemStyle = elem.style;
    
    if ( elemStyle.display != "block" ) {
      elemStyle.display = "block"
    } else {
      elemStyle.display = "none"
    }

    return true;
  }
  
  // Make codeblocks hidden by default
  document.writeln( "<style type=\"text/css\">div.method-source-code { display: none }</style>" )
  
  // ]]>
  </script>

</head>
<body>



    <div id="classHeader">
        <table class="header-table">
        <tr class="top-aligned-row">
          <td><strong>Class</strong></td>
          <td class="class-name-in-header">APICache</td>
        </tr>
        <tr class="top-aligned-row">
            <td><strong>In:</strong></td>
            <td>
                <a href="../files/lib/api_cache/abstract_store_rb.html">
                lib/api_cache/abstract_store.rb
                </a>
        <br />
                <a href="../files/lib/api_cache/api_rb.html">
                lib/api_cache/api.rb
                </a>
        <br />
                <a href="../files/lib/api_cache/cache_rb.html">
                lib/api_cache/cache.rb
                </a>
        <br />
                <a href="../files/lib/api_cache/memory_store_rb.html">
                lib/api_cache/memory_store.rb
                </a>
        <br />
                <a href="../files/lib/api_cache/moneta_store_rb.html">
                lib/api_cache/moneta_store.rb
                </a>
        <br />
                <a href="../files/lib/api_cache_rb.html">
                lib/api_cache.rb
                </a>
        <br />
            </td>
        </tr>

        <tr class="top-aligned-row">
            <td><strong>Parent:</strong></td>
            <td>
                Object
            </td>
        </tr>
        </table>
    </div>
  <!-- banner header -->

  <div id="bodyContent">



  <div id="contextContent">

    <div id="description">
      <p>
Contains the complete public <a href="APICache/API.html">API</a> for <a
href="APICache.html">APICache</a>.
</p>
<p>
See <a href="APICache.html#M000003">APICache.get</a> method and the README
file.
</p>
<p>
Before using <a href="APICache.html">APICache</a> you should set the store
to use using APICache.store=. For convenience, when no store is set an in
memory store will be used (and a warning will be logged).
</p>

    </div>


   </div>

    <div id="method-list">
      <h3 class="section-bar">Methods</h3>

      <div class="name-list">
      <a href="#M000003">get</a>&nbsp;&nbsp;
      <a href="#M000001">logger=</a>&nbsp;&nbsp;
      <a href="#M000002">store=</a>&nbsp;&nbsp;
      </div>
    </div>

  </div>


    <!-- if includes -->

    <div id="section">

    <div id="class-list">
      <h3 class="section-bar">Classes and Modules</h3>

      Class <a href="APICache/API.html" class="link">APICache::API</a><br />
Class <a href="APICache/AbstractStore.html" class="link">APICache::AbstractStore</a><br />
Class <a href="APICache/Cache.html" class="link">APICache::Cache</a><br />
Class <a href="APICache/CannotFetch.html" class="link">APICache::CannotFetch</a><br />
Class <a href="APICache/Invalid.html" class="link">APICache::Invalid</a><br />
Class <a href="APICache/MemoryStore.html" class="link">APICache::MemoryStore</a><br />
Class <a href="APICache/MonetaStore.html" class="link">APICache::MonetaStore</a><br />
Class <a href="APICache/NotAvailableError.html" class="link">APICache::NotAvailableError</a><br />

    </div>




    <div id="attribute-list">
      <h3 class="section-bar">Attributes</h3>

      <div class="name-list">
        <table>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">logger</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        <tr class="top-aligned-row context-row">
          <td class="context-item-name">store</td>
          <td class="context-item-value">&nbsp;[RW]&nbsp;</td>
          <td class="context-item-desc"></td>
        </tr>
        </table>
      </div>
    </div>
      


    <!-- if method_list -->
    <div id="methods">
      <h3 class="section-bar">Public Class methods</h3>

      <div id="method-M000003" class="method-detail">
        <a name="M000003"></a>

        <div class="method-heading">
          <a href="#M000003" class="method-signature">
          <span class="method-name">get</span><span class="method-args">(key, options = {}, &amp;block)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Raises an <a
href="APICache/NotAvailableError.html">APICache::NotAvailableError</a> if
it can&#8216;t <a href="APICache.html#M000003">get</a> a value. You should
rescue this if your application code.
</p>
<p>
Optionally call with a block. The value of the block is then used to set
the cache rather than calling the url. Use it for example if you need to
make another type of request, catch custom error codes etc. To signal that
the call failed just raise <a
href="APICache/Invalid.html">APICache::Invalid</a> - the value will then
not be cached and the api will not be called again for options[:timeout]
seconds. If an old value is available in the cache then it will be used.
</p>
<p>
For example:
</p>
<pre>
  APICache.get(&quot;http://twitter.com/statuses/user_timeline/6869822.atom&quot;)

  APICache.get    #     &quot;http://twitter.com/statuses/user_timeline/6869822.atom&quot;,
    :cache =&gt; 60, :valid =&gt; 600
</pre>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000003-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000003-source">
<pre>
     <span class="ruby-comment cmt"># File lib/api_cache.rb, line 78</span>
 78:   <span class="ruby-keyword kw">def</span> <span class="ruby-keyword kw">self</span>.<span class="ruby-identifier">get</span>(<span class="ruby-identifier">key</span>, <span class="ruby-identifier">options</span> = {}, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
 79:     <span class="ruby-identifier">options</span> = {
 80:       <span class="ruby-identifier">:cache</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">600</span>,    <span class="ruby-comment cmt"># 10 minutes  After this time fetch new data</span>
 81:       <span class="ruby-identifier">:valid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">86400</span>,  <span class="ruby-comment cmt"># 1 day       Maximum time to use old data</span>
 82:       <span class="ruby-comment cmt">#             :forever is a valid option</span>
 83:       <span class="ruby-identifier">:period</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">60</span>,    <span class="ruby-comment cmt"># 1 minute    Maximum frequency to call API</span>
 84:       <span class="ruby-identifier">:timeout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">5</span>     <span class="ruby-comment cmt"># 5 seconds   API response timeout</span>
 85:     }.<span class="ruby-identifier">merge</span>(<span class="ruby-identifier">options</span>)
 86: 
 87:     <span class="ruby-identifier">cache</span> = <span class="ruby-constant">APICache</span><span class="ruby-operator">::</span><span class="ruby-constant">Cache</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">key</span>, {
 88:       <span class="ruby-identifier">:cache</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:cache</span>],
 89:       <span class="ruby-identifier">:valid</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:valid</span>]
 90:     })
 91: 
 92:     <span class="ruby-identifier">api</span> = <span class="ruby-constant">APICache</span><span class="ruby-operator">::</span><span class="ruby-constant">API</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">key</span>, {
 93:       <span class="ruby-identifier">:period</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:period</span>],
 94:       <span class="ruby-identifier">:timeout</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-identifier">:timeout</span>]
 95:     }, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
 96: 
 97:     <span class="ruby-identifier">cache_state</span> = <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">state</span>
 98: 
 99:     <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cache_state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:current</span>
100:       <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">get</span>
101:     <span class="ruby-keyword kw">else</span>
102:       <span class="ruby-keyword kw">begin</span>
103:         <span class="ruby-identifier">value</span> = <span class="ruby-identifier">api</span>.<span class="ruby-identifier">get</span>
104:         <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">set</span>(<span class="ruby-identifier">value</span>)
105:         <span class="ruby-identifier">value</span>
106:       <span class="ruby-keyword kw">rescue</span> <span class="ruby-constant">APICache</span><span class="ruby-operator">::</span><span class="ruby-constant">CannotFetch</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">e</span>
107:         <span class="ruby-constant">APICache</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">info</span> <span class="ruby-value str">&quot;Failed to fetch new data from API because &quot;</span> \
108:           <span class="ruby-node">&quot;#{e.class}: #{e.message}&quot;</span>
109:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">cache_state</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">:refetch</span>
110:           <span class="ruby-identifier">cache</span>.<span class="ruby-identifier">get</span>
111:         <span class="ruby-keyword kw">else</span>
112:           <span class="ruby-constant">APICache</span>.<span class="ruby-identifier">logger</span>.<span class="ruby-identifier">warn</span> <span class="ruby-value str">&quot;Data not available in the cache or from API&quot;</span>
113:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">APICache</span><span class="ruby-operator">::</span><span class="ruby-constant">NotAvailableError</span>, <span class="ruby-identifier">e</span>.<span class="ruby-identifier">message</span>
114:         <span class="ruby-keyword kw">end</span>
115:       <span class="ruby-keyword kw">end</span>
116:     <span class="ruby-keyword kw">end</span>
117:   <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000001" class="method-detail">
        <a name="M000001"></a>

        <div class="method-heading">
          <a href="#M000001" class="method-signature">
          <span class="method-name">logger=</span><span class="method-args">(logger)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Set the logger to use. If not set, <tt>Logger.new(STDOUT)</tt> will be
used.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000001-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000001-source">
<pre>
    <span class="ruby-comment cmt"># File lib/api_cache.rb, line 31</span>
31:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">logger=</span>(<span class="ruby-identifier">logger</span>)
32:       <span class="ruby-ivar">@logger</span> = <span class="ruby-identifier">logger</span>
33:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>

      <div id="method-M000002" class="method-detail">
        <a name="M000002"></a>

        <div class="method-heading">
          <a href="#M000002" class="method-signature">
          <span class="method-name">store=</span><span class="method-args">(store)</span>
          </a>
        </div>
      
        <div class="method-description">
          <p>
Set the cache store to use. This should either be an instance of a moneta
store or a subclass of <a
href="APICache/AbstractStore.html">APICache::AbstractStore</a>. Moneta is
recommended.
</p>
          <p><a class="source-toggle" href="#"
            onclick="toggleCode('M000002-source');return false;">[Source]</a></p>
          <div class="method-source-code" id="M000002-source">
<pre>
    <span class="ruby-comment cmt"># File lib/api_cache.rb, line 46</span>
46:     <span class="ruby-keyword kw">def</span> <span class="ruby-identifier">store=</span>(<span class="ruby-identifier">store</span>)
47:       <span class="ruby-ivar">@store</span> = <span class="ruby-keyword kw">begin</span>
48:         <span class="ruby-keyword kw">if</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">class</span> <span class="ruby-operator">&lt;</span> <span class="ruby-constant">APICache</span><span class="ruby-operator">::</span><span class="ruby-constant">AbstractStore</span>
49:           <span class="ruby-identifier">store</span>
50:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">=~</span> <span class="ruby-regexp re">/Moneta/</span>
51:           <span class="ruby-constant">MonetaStore</span>.<span class="ruby-identifier">new</span>(<span class="ruby-identifier">store</span>)
52:         <span class="ruby-keyword kw">elsif</span> <span class="ruby-identifier">store</span>.<span class="ruby-identifier">nil?</span>
53:           <span class="ruby-keyword kw">nil</span>
54:         <span class="ruby-keyword kw">else</span>
55:           <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-value str">&quot;Please supply an instance of either a moneta store or a subclass of APICache::AbstractStore&quot;</span>
56:         <span class="ruby-keyword kw">end</span>
57:       <span class="ruby-keyword kw">end</span>
58:     <span class="ruby-keyword kw">end</span>
</pre>
          </div>
        </div>
      </div>


    </div>


  </div>


<div id="validator-badges">
  <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
</div>

</body>
</html>